#include <Arduino.h>
#include <WiFi.h>
#include <esp_wifi.h>

// ===== Cáº¤U HÃŒNH WIFI =====
const char* WIFI_SSID = "207";
const char* WIFI_PASS = "11022003";
const char* SERVER_IP = "192.168.1.8";
const int SERVER_PORT = 8888;

// ===== BIáº¾N TOÃ€N Cá»¤C =====
WiFiClient client;
unsigned long lastReconnect = 0;
int reconnectCount = 0;

void setup() {
    Serial.begin(115200);
    delay(2000);
    
    Serial.println("\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Serial.println("â•‘   WIFI & NETWORK TEST - SMART PARKING       â•‘");
    Serial.println("â•‘   Kiá»ƒm tra káº¿t ná»‘i WiFi vÃ  TCP Server       â•‘");
    Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    
    // ===== POWER OPTIMIZATION (Chá»‘ng Brownout) =====
    Serial.println("âš¡ [POWER OPTIMIZATION]");
    
    // 1. Giáº£m táº§n sá»‘ CPU xuá»‘ng 80MHz (má»©c tháº¥p nháº¥t á»•n Ä‘á»‹nh)
    setCpuFrequencyMhz(80);
    Serial.printf("   CPU Frequency: %d MHz\n", getCpuFrequencyMhz());
    
    // 2. Táº¯t Bluetooth (tiáº¿t kiá»‡m ~40mA)
    btStop();
    Serial.println("   Bluetooth: DISABLED");
    
    Serial.println("   âœ“ Power optimization applied\n");
    Serial.println("âš ï¸  HARDWARE WARNING:");
    Serial.println("   ESP32 cáº§n nguá»“n á»•n Ä‘á»‹nh 5V/500mA khi dÃ¹ng WiFi!");
    Serial.println("   - Thá»­ dÃ¢y USB khÃ¡c hoáº·c nguá»“n ngoÃ i 5V/1A");
    Serial.println("   - Gáº¯n tá»¥ 470ÂµF gáº§n chÃ¢n VIN/GND cá»§a ESP32");
    Serial.println("   - Ngáº¯t káº¿t ná»‘i cÃ¡c thiáº¿t bá»‹ khÃ¡c (RFID, Servo...)\n");
    delay(2000);
    
    // Test 1: Kiá»ƒm tra WiFi Radio (khá»Ÿi Ä‘á»™ng tá»« tá»«)
    Serial.println("ğŸ“¡ [TEST 1/4] WiFi Hardware");
    Serial.println("   Checking WiFi radio...");
    Serial.println("   Initializing slowly to reduce power surge...");
    
    // Táº¯t WiFi trÆ°á»›c khi cáº¥u hÃ¬nh
    WiFi.mode(WIFI_OFF);
    delay(500);
    
    // Giáº£m cÃ´ng suáº¥t WiFi TRÆ¯á»šC KHI báº­t
    esp_wifi_set_max_tx_power(8); // 2dBm (tháº¥p nháº¥t)
    delay(200);
    
    // Báº­t WiFi tá»« tá»«
    WiFi.mode(WIFI_STA);
    delay(500);
    
    // Kiá»ƒm tra xem cÃ³ brownout khÃ´ng
    Serial.println("   Waiting for stability...");
    delay(1000);
    
    Serial.println("   âœ“ WiFi radio OK (no brownout)\n");
    
    // Test 2: Káº¿t ná»‘i WiFi
    Serial.println("ğŸ“¶ [TEST 2/4] WiFi Connection");
    Serial.printf("   SSID: %s\n", WIFI_SSID);
    Serial.println("   Connecting with MINIMUM power...");
    
    // Cáº¥u hÃ¬nh tiáº¿t kiá»‡m Ä‘iá»‡n Tá»I ÄA trÆ°á»›c khi connect
    WiFi.setTxPower(WIFI_POWER_2dBm); // CÃ´ng suáº¥t tháº¥p nháº¥t
    WiFi.setSleep(WIFI_PS_MAX_MODEM); // Sleep tá»‘i Ä‘a
    delay(200);
    
    WiFi.begin(WIFI_SSID, WIFI_PASS);
    
    int attempts = 0;
    while (WiFi.status() != WL_CONNECTED && attempts < 20) {
        delay(500);
        Serial.print(".");
        attempts++;
    }
    Serial.println();
    
    if (WiFi.status() == WL_CONNECTED) {
        Serial.println("   âœ“ WiFi Connected!");
        Serial.printf("   IP Address: %s\n", WiFi.localIP().toString().c_str());
        Serial.printf("   Signal Strength: %d dBm\n", WiFi.RSSI());
        Serial.printf("   MAC Address: %s\n\n", WiFi.macAddress().c_str());
    } else {
        Serial.println("   âœ— WiFi Connection FAILED!");
        Serial.println("   â†’ Kiá»ƒm tra SSID vÃ  password");
        Serial.println("   â†’ Kiá»ƒm tra WiFi router cÃ³ báº­t khÃ´ng");
        Serial.println("\n   ğŸ”„ Há»‡ thá»‘ng sáº½ thá»­ káº¿t ná»‘i láº¡i...\n");
    }
    
    // Test 3: Kiá»ƒm tra DNS
    Serial.println("ğŸŒ [TEST 3/4] Network Configuration");
    if (WiFi.status() == WL_CONNECTED) {
        Serial.printf("   Gateway: %s\n", WiFi.gatewayIP().toString().c_str());
        Serial.printf("   Subnet: %s\n", WiFi.subnetMask().toString().c_str());
        Serial.printf("   DNS: %s\n", WiFi.dnsIP().toString().c_str());
        Serial.println("   âœ“ Network config OK\n");
    } else {
        Serial.println("   âš ï¸ Skip (WiFi not connected)\n");
    }
    
    // Test 4: Káº¿t ná»‘i TCP Server
    Serial.println("ğŸ”Œ [TEST 4/4] TCP Server Connection");
    if (WiFi.status() == WL_CONNECTED) {
        Serial.printf("   Server: %s:%d\n", SERVER_IP, SERVER_PORT);
        Serial.println("   Connecting...");
        
        if (client.connect(SERVER_IP, SERVER_PORT)) {
            Serial.println("   âœ“ TCP Connection OK!");
            Serial.println("   Sending test message...");
            
            client.println("HELLO_FROM_ESP32_TEST");
            delay(500);
            
            if (client.available()) {
                String response = client.readStringUntil('\n');
                Serial.printf("   Server response: %s\n", response.c_str());
            } else {
                Serial.println("   âš ï¸ No response from server (timeout)");
            }
            
            client.stop();
        } else {
            Serial.println("   âœ— TCP Connection FAILED!");
            Serial.println("   â†’ Kiá»ƒm tra Python app Ä‘Ã£ cháº¡y chÆ°a");
            Serial.println("   â†’ Kiá»ƒm tra IP server Ä‘Ãºng khÃ´ng");
            Serial.println("   â†’ Kiá»ƒm tra firewall cÃ³ cháº·n port 8888 khÃ´ng");
        }
    } else {
        Serial.println("   âš ï¸ Skip (WiFi not connected)");
    }
    
    Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Serial.println("â•‘   CONTINUOUS MONITORING                      â•‘");
    Serial.println("â•‘   Theo dÃµi tráº¡ng thÃ¡i WiFi liÃªn tá»¥c         â•‘");
    Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void loop() {
    static unsigned long lastCheck = 0;
    static unsigned long lastPing = 0;
    
    // Kiá»ƒm tra WiFi má»—i 5 giÃ¢y
    if (millis() - lastCheck > 5000) {
        lastCheck = millis();
        
        Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
        Serial.printf("â° Time: %lu ms\n", millis());
        
        // Status WiFi
        if (WiFi.status() == WL_CONNECTED) {
            Serial.printf("ğŸ“¶ WiFi: âœ“ Connected | IP: %s | RSSI: %d dBm\n", 
                         WiFi.localIP().toString().c_str(), 
                         WiFi.RSSI());
        } else {
            Serial.println("ğŸ“¶ WiFi: âœ— Disconnected - Reconnecting...");
            WiFi.disconnect();
            WiFi.begin(WIFI_SSID, WIFI_PASS);
            reconnectCount++;
        }
        
        // Status TCP
        if (client.connected()) {
            Serial.printf("ğŸ”Œ TCP: âœ“ Connected to %s:%d\n", SERVER_IP, SERVER_PORT);
        } else {
            Serial.println("ğŸ”Œ TCP: âœ— Disconnected");
        }
        
        Serial.printf("ğŸ“Š Stats: Reconnects=%d\n", reconnectCount);
        Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
    }
    
    // Thá»­ káº¿t ná»‘i láº¡i TCP má»—i 10 giÃ¢y náº¿u máº¥t káº¿t ná»‘i
    if (!client.connected() && WiFi.status() == WL_CONNECTED) {
        if (millis() - lastReconnect > 10000) {
            lastReconnect = millis();
            
            Serial.println("ğŸ”„ Attempting TCP reconnect...");
            if (client.connect(SERVER_IP, SERVER_PORT)) {
                Serial.println("   âœ“ Reconnected!");
                client.println("HELLO_FROM_ESP32_TEST");
            } else {
                Serial.println("   âœ— Reconnect failed");
            }
        }
    }
    
    // Ping server má»—i 30 giÃ¢y náº¿u Ä‘ang káº¿t ná»‘i
    if (client.connected() && millis() - lastPing > 30000) {
        lastPing = millis();
        
        Serial.println("ğŸ“ Sending PING to server...");
        client.println("PING");
        
        delay(100);
        if (client.available()) {
            String response = client.readStringUntil('\n');
            Serial.printf("   Server: %s\n", response.c_str());
        }
    }
    
    // Äá»c dá»¯ liá»‡u tá»« server náº¿u cÃ³
    if (client.available()) {
        String data = client.readStringUntil('\n');
        data.trim();
        Serial.printf("ğŸ“© Received: %s\n", data.c_str());
    }
    
    delay(100);
}
