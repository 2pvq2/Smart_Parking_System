/*
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *  ğŸ§ª TEST SENSORS - DEBUG 10 Cáº¢M BIáº¾N BÃƒI Äá»– XE
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *  Chá»©c nÄƒng:
 *  - Äá»c trá»±c tiáº¿p tÃ­n hiá»‡u tá»« 10 GPIO
 *  - Hiá»ƒn thá»‹ giÃ¡ trá»‹ RAW (HIGH/LOW) realtime
 *  - Hiá»ƒn thá»‹ tráº¡ng thÃ¡i OCCUPIED/AVAILABLE
 *  - Test debounce
 *  - Thá»‘ng kÃª sá»‘ láº§n thay Ä‘á»•i
 * 
 *  CÃ¡ch dÃ¹ng:
 *  1. Comment out file main.cpp trong platformio.ini
 *  2. Build & Upload file nÃ y
 *  3. Má»Ÿ Serial Monitor (115200 baud)
 *  4. Che/bá» tay vÃ o sensor Ä‘á»ƒ test
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

#include <Arduino.h>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Cáº¤U HÃŒNH CHÃ‚N Cáº¢M BIáº¾N (Giá»‘ng file chÃ­nh)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const int SENSOR_PINS[10] = {26, 27, 14, 33, 13, 4, 16, 17, 18, 19};
const int TOTAL_SENSORS = 10;
const int STATUS_LED = 2;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Cáº¤U HÃŒNH TEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const unsigned long UPDATE_INTERVAL = 500;    // Cáº­p nháº­t má»—i 500ms
const bool INVERT_LOGIC = false;              // false: LOW=cÃ³ xe, true: HIGH=cÃ³ xe
const unsigned long DEBOUNCE_TIME = 300;      // 300ms debounce

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STRUCT LÆ¯U TRáº NG THÃI SENSOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
struct SensorState {
    int pin;
    int rawValue;                  // GiÃ¡ trá»‹ RAW tá»« digitalRead
    bool occupied;                 // Tráº¡ng thÃ¡i sau khi xá»­ lÃ½
    bool previousOccupied;         // Tráº¡ng thÃ¡i trÆ°á»›c Ä‘Ã³
    unsigned long lastChangeTime;  // Thá»i gian thay Ä‘á»•i cuá»‘i
    int changeCount;               // Sá»‘ láº§n thay Ä‘á»•i
};

SensorState sensors[TOTAL_SENSORS];
unsigned long lastPrintTime = 0;
unsigned long lastBlinkTime = 0;
bool ledState = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FUNCTION PROTOTYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void initializeSensors();
void readAllSensors();
void printHeader();
void printSensorStatus();
void printDetailedInfo();
void printStatistics();
void blinkLED();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void setup() {
    Serial.begin(115200);
    delay(1000);
    
    Serial.println("\n\n\n");
    Serial.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Serial.println("â•‘                                                                   â•‘");
    Serial.println("â•‘            ğŸ§ª SENSOR TEST MODE - 10 PARKING SENSORS ğŸ§ª           â•‘");
    Serial.println("â•‘                                                                   â•‘");
    Serial.println("â•‘     Test tÃ­n hiá»‡u tá»« 10 cáº£m biáº¿n bÃ£i Ä‘á»— xe - Realtime Debug     â•‘");
    Serial.println("â•‘                                                                   â•‘");
    Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Serial.println();
    
    // Khá»Ÿi táº¡o LED
    pinMode(STATUS_LED, OUTPUT);
    digitalWrite(STATUS_LED, LOW);
    
    // Khá»Ÿi táº¡o sensors
    initializeSensors();
    
    Serial.println("\nâœ… Khá»Ÿi táº¡o hoÃ n táº¥t! Báº¯t Ä‘áº§u Ä‘á»c sensors...\n");
    Serial.println("ğŸ“Œ HÆ°á»›ng dáº«n:");
    Serial.println("   - Che tay vÃ o sensor Ä‘á»ƒ test");
    Serial.println("   - Xem giÃ¡ trá»‹ RAW vÃ  tráº¡ng thÃ¡i thay Ä‘á»•i");
    Serial.println("   - LED onboard sáº½ nháº¥p nhÃ¡y khi cÃ³ hoáº¡t Ä‘á»™ng\n");
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    
    delay(2000);
    printHeader();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void loop() {
    unsigned long currentTime = millis();
    
    // Äá»c táº¥t cáº£ sensors
    readAllSensors();
    
    // In status má»—i UPDATE_INTERVAL
    if (currentTime - lastPrintTime >= UPDATE_INTERVAL) {
        printSensorStatus();
        lastPrintTime = currentTime;
    }
    
    // Nháº¥p nhÃ¡y LED
    blinkLED();
    
    // Nháº¥n Enter Ä‘á»ƒ xem chi tiáº¿t
    if (Serial.available()) {
        char c = Serial.read();
        if (c == '\n' || c == '\r') {
            printDetailedInfo();
            printStatistics();
        }
    }
    
    delay(50);  // Delay nhá» Ä‘á»ƒ trÃ¡nh CPU quÃ¡ táº£i
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void initializeSensors() {
    Serial.println("ğŸ”§ Initializing sensors...\n");
    
    for (int i = 0; i < TOTAL_SENSORS; i++) {
        sensors[i].pin = SENSOR_PINS[i];
        sensors[i].rawValue = 0;
        sensors[i].occupied = false;
        sensors[i].previousOccupied = false;
        sensors[i].lastChangeTime = 0;
        sensors[i].changeCount = 0;
        
        pinMode(sensors[i].pin, INPUT_PULLUP);
        
        Serial.printf("   ğŸ“ Sensor %2d â†’ GPIO %2d (Mode: INPUT_PULLUP)\n", i + 1, sensors[i].pin);
    }
    
    Serial.println();
    Serial.printf("âš™ï¸  Configuration:\n");
    Serial.printf("   - Total Sensors: %d\n", TOTAL_SENSORS);
    Serial.printf("   - Logic: %s\n", INVERT_LOGIC ? "HIGH=occupied" : "LOW=occupied");
    Serial.printf("   - Debounce: %lu ms\n", DEBOUNCE_TIME);
    Serial.printf("   - Update Rate: %lu ms\n", UPDATE_INTERVAL);
}

void readAllSensors() {
    unsigned long currentTime = millis();
    
    for (int i = 0; i < TOTAL_SENSORS; i++) {
        // Äá»c giÃ¡ trá»‹ RAW
        sensors[i].rawValue = digitalRead(sensors[i].pin);
        
        // Xá»­ lÃ½ logic (invert náº¿u cáº§n)
        bool currentOccupied;
        if (INVERT_LOGIC) {
            currentOccupied = (sensors[i].rawValue == HIGH);
        } else {
            currentOccupied = (sensors[i].rawValue == LOW);
        }
        
        // Debounce: Chá»‰ cáº­p nháº­t náº¿u tráº¡ng thÃ¡i thay Ä‘á»•i vÃ  Ä‘Ã£ Ä‘á»§ thá»i gian
        if (currentOccupied != sensors[i].occupied) {
            if (currentTime - sensors[i].lastChangeTime >= DEBOUNCE_TIME) {
                sensors[i].previousOccupied = sensors[i].occupied;
                sensors[i].occupied = currentOccupied;
                sensors[i].lastChangeTime = currentTime;
                sensors[i].changeCount++;
                
                // Log thay Ä‘á»•i
                Serial.printf("\nğŸ”„ [CHANGE] Sensor %d: %s â†’ %s (Count: %d)\n",
                             i + 1,
                             sensors[i].previousOccupied ? "ğŸ”´ OCCUPIED" : "ğŸŸ¢ AVAILABLE",
                             currentOccupied ? "ğŸ”´ OCCUPIED" : "ğŸŸ¢ AVAILABLE",
                             sensors[i].changeCount);
            }
        }
    }
}

void printHeader() {
    Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    Serial.println("â”‚  #  â”‚ GPIO â”‚  RAW  â”‚  STATUS   â”‚ TIME â”‚ COUNT â”‚      BINARY STATUS      â”‚");
    Serial.println("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
}

void printSensorStatus() {
    // Clear previous lines (move cursor up)
    for (int i = 0; i < TOTAL_SENSORS; i++) {
        Serial.print("\033[A");  // Move up
    }
    
    String binaryStatus = "";
    int occupiedCount = 0;
    
    for (int i = 0; i < TOTAL_SENSORS; i++) {
        // Táº¡o chuá»—i binary
        binaryStatus += sensors[i].occupied ? "1" : "0";
        if (sensors[i].occupied) occupiedCount++;
        
        // In tá»«ng sensor
        Serial.printf("â”‚ %2d  â”‚  %2d  â”‚ %s â”‚ %s â”‚ %4lus â”‚  %3d  â”‚",
                     i + 1,
                     sensors[i].pin,
                     sensors[i].rawValue ? "HIGH" : "LOW ",
                     sensors[i].occupied ? "ğŸ”´ OCCUPIED " : "ğŸŸ¢ AVAILABLE",
                     (millis() - sensors[i].lastChangeTime) / 1000,
                     sensors[i].changeCount);
        
        // In binary status (chá»‰ in á»Ÿ dÃ²ng Ä‘áº§u)
        if (i == 0) {
            Serial.printf(" %s â”‚\n", binaryStatus.c_str());
        } else {
            Serial.println("                         â”‚");
        }
    }
    
    Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
    Serial.printf("ğŸ“Š Summary: %d occupied, %d available | Binary: %s\n", 
                 occupiedCount, TOTAL_SENSORS - occupiedCount, binaryStatus.c_str());
    Serial.println();
}

void printDetailedInfo() {
    Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Serial.println("               ğŸ“‹ DETAILED SENSOR INFORMATION");
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    for (int i = 0; i < TOTAL_SENSORS; i++) {
        Serial.printf("\nğŸ”¹ SENSOR %d (GPIO %d):\n", i + 1, sensors[i].pin);
        Serial.printf("   â””â”€ RAW Value: %s (%d)\n", 
                     sensors[i].rawValue ? "HIGH" : "LOW", sensors[i].rawValue);
        Serial.printf("   â””â”€ Status: %s\n", 
                     sensors[i].occupied ? "ğŸ”´ OCCUPIED" : "ğŸŸ¢ AVAILABLE");
        Serial.printf("   â””â”€ Last Change: %lu ms ago\n", 
                     millis() - sensors[i].lastChangeTime);
        Serial.printf("   â””â”€ Change Count: %d times\n", sensors[i].changeCount);
    }
    
    Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void printStatistics() {
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Serial.println("                    ğŸ“ˆ STATISTICS");
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    int totalOccupied = 0;
    int totalChanges = 0;
    int maxChanges = 0;
    int minChanges = sensors[0].changeCount;
    
    for (int i = 0; i < TOTAL_SENSORS; i++) {
        if (sensors[i].occupied) totalOccupied++;
        totalChanges += sensors[i].changeCount;
        if (sensors[i].changeCount > maxChanges) maxChanges = sensors[i].changeCount;
        if (sensors[i].changeCount < minChanges) minChanges = sensors[i].changeCount;
    }
    
    Serial.printf("ğŸ…¿ï¸  Total Sensors: %d\n", TOTAL_SENSORS);
    Serial.printf("ğŸ”´ Occupied Slots: %d\n", totalOccupied);
    Serial.printf("ğŸŸ¢ Available Slots: %d\n", TOTAL_SENSORS - totalOccupied);
    Serial.printf("ğŸ”„ Total Changes: %d\n", totalChanges);
    Serial.printf("ğŸ“Š Max Changes (Single Sensor): %d\n", maxChanges);
    Serial.printf("ğŸ“Š Min Changes (Single Sensor): %d\n", minChanges);
    Serial.printf("â±ï¸  Uptime: %lu seconds\n", millis() / 1000);
    
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void blinkLED() {
    unsigned long currentTime = millis();
    
    // Nháº¥p nhÃ¡y nhanh náº¿u cÃ³ sensor OCCUPIED
    bool hasOccupied = false;
    for (int i = 0; i < TOTAL_SENSORS; i++) {
        if (sensors[i].occupied) {
            hasOccupied = true;
            break;
        }
    }
    
    unsigned long blinkInterval = hasOccupied ? 200 : 1000;  // Nhanh hÆ¡n khi cÃ³ xe
    
    if (currentTime - lastBlinkTime >= blinkInterval) {
        ledState = !ledState;
        digitalWrite(STATUS_LED, ledState ? HIGH : LOW);
        lastBlinkTime = currentTime;
    }
}
